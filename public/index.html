<link
  rel="stylesheet"
  href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
/>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"
  integrity="sha512-9mpsATI0KClwt+xVZfbcf2lJ8IFBAwsubJ6mI3rtULwyM3fBmQFzj0It4tGqxLOGQwGfJdk/G+fANnxfq9/cew=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
<script src="https://unpkg.com/vue@3"></script>

<body>
  <main class="container" id="app">
    <button @click="logout" class="contrast">D√©connexion</button>
    <article class="grid" v-if="layout == 'login'">
      <div>
        <hgroup>
          <h1>Sign in</h1>
          <h2>A minimalist layout for Login pages</h2>
        </hgroup>
        <form @submit.prevent="login">
          <input
            type="text"
            name="login"
            placeholder="Login"
            aria-label="Login"
            autocomplete="nickname"
            required
            v-model="email"
          />
          <input
            type="password"
            name="password"
            placeholder="Password"
            aria-label="Password"
            autocomplete="current-password"
            required
            v-model="password"
          />
          <button class="contrast">Login</button>
        </form>
      </div>
      <div></div>
    </article>
    <article v-else>
      <h1>Cr√©er un utilisateur</h1>
      <form @submit.prevent="create">
        <input type="text" placeholder="Name" required v-model="newUser.name" />
        <input
          type="text"
          placeholder="Email"
          required
          v-model="newUser.email"
        />
        <input
          type="text"
          placeholder="Password"
          required
          v-model="newUser.password"
        />
        <button class="contrast">Cr√©er</button>
      </form>
      <h1>Utilisateur existant</h1>
      <table>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="user in users">
            <td>{{ user._id }}</td>
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td><button @click="remove(user._id)">Supprimer</button></td>
          </tr>
        </tbody>
      </table>

      <hr />
      <h1>Articles en direct üì°</h1>

      <button @click="showArticleForm = !showArticleForm" class="contrast">
        ‚ûï Ajouter un article
      </button>

      <form
        v-if="showArticleForm"
        @submit.prevent="createArticle"
        style="margin-top: 1rem"
      >
        <input
          type="text"
          placeholder="Titre"
          v-model="newArticle.title"
          required
        />
        <input
          type="text"
          placeholder="Contenu"
          v-model="newArticle.content"
          required
        />
        <select v-model="newArticle.status" required>
          <option disabled value="">Choisir un statut</option>
          <option value="draft">Brouillon</option>
          <option value="published">Publi√©</option>
        </select>
        <button type="submit" class="contrast">Cr√©er</button>
      </form>

      <ul>
        <li v-for="article in articles">
          <strong>{{ article.title }}</strong>:<br />
          <em>{{ article.content }}</em> <br />
          ‚úçÔ∏è Auteur : <code>{{ article.user?.name }}</code>
          <br />
          <button @click="editArticle(article)" class="outline">‚úèÔ∏è</button>
          <button @click="deleteArticle(article._id)" class="contrast">
            üóëÔ∏è
          </button>
        </li>
      </ul>

      <form
        v-if="showArticleForm"
        @submit.prevent="submitArticle"
        style="margin-top: 1rem"
      >
        <input
          type="text"
          placeholder="Titre"
          v-model="newArticle.title"
          required
        />
        <input
          type="text"
          placeholder="Contenu"
          v-model="newArticle.content"
          required
        />
        <select v-model="newArticle.status" required>
          <option disabled value="">Choisir un statut</option>
          <option value="draft">Brouillon</option>
          <option value="published">Publi√©</option>
        </select>
        <button type="submit" class="contrast">
          {{ editingArticleId ? "Modifier" : "Cr√©er" }}
        </button>
      </form>
    </article>
  </main>
</body>

<script>
  const { createApp } = Vue;

  const socket = io();

  createApp({
    data() {
      return {
        layout: "login",
        email: "",
        password: "",
        users: [],
        articles: [],
        newUser: {},
        userToken: "",
        showArticleForm: false,
        newArticle: {
          title: "",
          content: "",
          status: "",
        },
        editingArticleId: null,
      };
    },
    mounted() {
      this.load();
      socket.on("article:create", (data) => {
        this.articles.push(data);
      });
      socket.on("article:update", (updatedArticle) => {
        const index = this.articles.findIndex(
          (a) => a._id === updatedArticle._id
        );
        if (index !== -1) this.articles[index] = updatedArticle;
      });

      socket.on("article:delete", ({ id }) => {
        this.articles = this.articles.filter((a) => a._id !== id);
      });
    },
    methods: {
      async login() {
        const { token } = await axios
          .post("/login", {
            email: this.email,
            password: this.password,
          })
          .then((res) => res.data);
        localStorage.setItem("token", token);
        this.load();
      },

      async createArticle() {
        await axios.post("/api/articles", this.newArticle, {
          headers: {
            "x-access-token": this.userToken,
          },
        });
        this.newArticle = { title: "", content: "", status: "" };
        this.showArticleForm = false;
      },
      async loadArticles() {
        const res = await axios.get("/api/articles", {
          headers: {
            "x-access-token": this.userToken,
          },
        });
        this.articles = res.data;
      },

      editArticle(article) {
        this.newArticle = {
          title: article.title,
          content: article.content,
          status: article.status,
        };
        this.editingArticleId = article._id;
        this.showArticleForm = true;
      },

      async submitArticle() {
        if (this.editingArticleId) {
          await axios.put(
            "/api/articles/" + this.editingArticleId,
            this.newArticle,
            {
              headers: {
                "x-access-token": this.userToken,
              },
            }
          );
        } else {
          await axios.post("/api/articles", this.newArticle, {
            headers: {
              "x-access-token": this.userToken,
            },
          });
        }

        this.newArticle = { title: "", content: "", status: "" };
        this.showArticleForm = false;
        this.editingArticleId = null;
      },

      async deleteArticle(id) {
        await axios.delete("/api/articles/" + id, {
          headers: {
            "x-access-token": this.userToken,
          },
        });
      },

      async load() {
        this.userToken = localStorage.getItem("token");
        if (this.userToken) {
          this.layout = "list";
          await this.loadArticles();
          const users = await axios
            .get("/api/users", {
              headers: {
                "x-access-token": this.userToken,
              },
            })
            .then((res) => res.data);
          this.users = users;
        }

        socket.on("user:create", (data) => {
          this.users.push(data);
        });

        socket.on("user:delete", (data) => {
          this.users = this.users.filter((user) => user._id != data.id);
        });
      },
      async remove(userId) {
        await axios.delete("/api/users/" + userId, {
          headers: {
            "x-access-token": this.userToken,
          },
        });
      },
      async create() {
        await axios
          .post("/api/users", this.newUser, {
            headers: {
              "x-access-token": this.userToken,
            },
          })
          .then((res) => res.data);
      },

      logout() {
        localStorage.removeItem("token");
        this.userToken = "";
        this.layout = "login";
        this.email = "";
        this.password = "";
        this.users = [];
      },
    },
  }).mount("#app");
</script>
